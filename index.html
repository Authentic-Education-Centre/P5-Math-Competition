<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å¹´çº§æ•°å­¦ç«èµ› - åœ¨çº¿ç‰ˆ</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Login Screen Styles */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }

        .role-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .role-btn {
            flex: 1;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
        }

        .role-btn:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .role-btn.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .error-message {
            background: #ffe3e3;
            color: #c92a2a;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* User Info Bar - Elegant Design */
        .user-info-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .user-info-left {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            font-weight: 500;
        }

        .user-role-badge {
            background: rgba(255,255,255,0.25);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-size: 1.05em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 18px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        /* Game Container */
        .game-container {
            display: none;
        }

        .game-container.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-control {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-control:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-start-all {
            background: #51cf66;
            color: white;
        }
        
        .btn-start-all:hover:not(:disabled) {
            background: #37b24d;
            transform: translateY(-2px);
        }
        
        .btn-pause {
            background: #ffa500;
            color: white;
        }
        
        .btn-pause:hover:not(:disabled) {
            background: #ff8c00;
            transform: translateY(-2px);
        }
        
        .btn-end {
            background: #ff6b6b;
            color: white;
        }
        
        .btn-end:hover:not(:disabled) {
            background: #ee5555;
            transform: translateY(-2px);
        }

        .competition-status {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .question-area {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .question-display {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer {
            font-size: 3em;
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }

        .student-selector {
            margin: 20px 0;
        }

        .student-selector select {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 3px solid #667eea;
            border-radius: 10px;
        }

        .answer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .answer-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-correct {
            background: #51cf66;
            color: white;
        }

        .btn-correct:hover {
            background: #37b24d;
            transform: scale(1.05);
        }

        .btn-wrong {
            background: #ff6b6b;
            color: white;
        }

        .btn-wrong:hover {
            background: #ee5555;
            transform: scale(1.05);
        }

        .btn-skip {
            background: #868e96;
            color: white;
        }

        .btn-skip:hover {
            background: #6c757d;
            transform: scale(1.05);
        }

        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback.correct {
            background: #d3f9d8;
            color: #2f9e44;
        }

        .feedback.incorrect {
            background: #ffe3e3;
            color: #c92a2a;
        }

        .leaderboard {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .leaderboard h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .student-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .student-card.rank-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
        }

        .student-card.rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            box-shadow: 0 5px 20px rgba(192, 192, 192, 0.4);
        }

        .student-card.rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e6a869 100%);
            box-shadow: 0 5px 20px rgba(205, 127, 50, 0.4);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rank-badge {
            background: #667eea;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .student-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .student-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .emoji-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em;
            animation: emojiPop 1s ease-out;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes emojiPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        #messageArea {
            margin: 10px 0;
        }

        .message {
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            font-weight: bold;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Student View Styles */
        .student-view-notice {
            background: #e7f5ff;
            color: #1971c2;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ“ æ•°å­¦ç«èµ›</h1>
            <p>è¯·é€‰æ‹©ä½ çš„èº«ä»½</p>

            <div class="role-buttons">
                <div class="role-btn" id="teacherRoleBtn">
                    <div style="font-size:2.5em;">ğŸ‘¨â€ğŸ«</div>
                    <div>è€å¸ˆ</div>
                </div>
                <div class="role-btn" id="studentRoleBtn">
                    <div style="font-size:2.5em;">ğŸ‘¨â€ğŸ“</div>
                    <div>å­¦ç”Ÿ</div>
                </div>
            </div>

            <div id="errorMessage" class="error-message"></div>

            <!-- Teacher Login Form -->
            <div class="login-form" id="teacherForm">
                <div class="form-group">
                    <label>è€å¸ˆå¯†ç ï¼š</label>
                    <input type="password" id="teacherPassword" placeholder="è¾“å…¥å¯†ç ">
                </div>
                <button class="login-btn" onclick="loginAsTeacher()">ç™»å½•</button>
            </div>

            <!-- Student Login Form -->
            <div class="login-form" id="studentForm">
                <div class="form-group">
                    <label>é€‰æ‹©ä½ çš„åå­—ï¼š</label>
                    <select id="studentName">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        <option value="çºªå­è°¦">çºªå­è°¦</option>
                        <option value="å”å­è°¦">å”å­è°¦</option>
                        <option value="å°¤å­ç’‡">å°¤å­ç’‡</option>
                        <option value="é™ˆæ­†åªƒ">é™ˆæ­†åªƒ</option>
                        <option value="é™ˆå­æ¬£">é™ˆå­æ¬£</option>
                        <option value="å°¤å®‰å®œ">å°¤å®‰å®œ</option>
                        <option value="æ±ŸåŠ²æ¯…">æ±ŸåŠ²æ¯…</option>
                        <option value="å¶éˆŠå„¿">å¶éˆŠå„¿</option>
                        <option value="ç¿æ©é›…">ç¿æ©é›…</option>
                        <option value="æ—èŠŠå¦¤">æ—èŠŠå¦¤</option>
                        <option value="æ—ä¿Šè±">æ—ä¿Šè±</option>
                        <option value="æ›¹ç¿">æ›¹ç¿</option>
                        <option value="éƒ­å¾®å¾®">éƒ­å¾®å¾®</option>
                    </select>
                </div>
                <button class="login-btn" onclick="loginAsStudent()">è¿›å…¥</button>
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
        <div class="container">
            <div class="header">
                <h1>ğŸ“ äº”å¹´çº§æ•°å­¦ç«èµ› ğŸ“</h1>
                <p style="font-size: 1.2em; color: #666;">ç›®æ ‡ï¼š80åˆ† | ç­”å¯¹+3åˆ† | ç­”é”™-5åˆ† | æ²¡äººç­”å¯¹å…¨ä½“-8åˆ†</p>
                <p style="font-size: 1em; color: #999; margin-top: 5px;">â° æ¸¸æˆæ—¶é—´æ¯é€¢æ˜ŸæœŸä¸‰8.00pm-8.30pm</p>
            </div>

            <div class="main-content">
                <div class="left-panel">
                    <!-- User Info Bar -->
                    <div class="user-info-bar">
                        <div class="user-info-left">
                            <span class="user-role-badge" id="userRoleBadge">è€å¸ˆ</span>
                            <span class="user-name" id="userName">åŠ è½½ä¸­...</span>
                        </div>
                        <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
                    </div>

                    <!-- Control Panel (Teacher Only) -->
                    <div class="control-panel" id="controlPanel">
                        <div class="competition-status" id="competitionStatus">å‡†å¤‡å¼€å§‹ç«èµ›</div>
                        <div id="timeWarning" style="color: #ff6b6b; font-weight: bold; font-size: 1.1em; margin: 10px 0; display: none;"></div>
                        <div id="messageArea"></div>
                        <div class="control-buttons">
                            <button class="btn-control btn-start-all" id="startAllBtn" onclick="startCompetition()">
                                ğŸš€ å¼€å§‹ç«èµ›
                            </button>
                            <button class="btn-control btn-pause" id="pauseBtn" onclick="pauseCompetition()" disabled style="background: #ffa500;">
                                â¸ï¸ æš‚åœ
                            </button>
                            <button class="btn-control" id="addPlayerBtn" onclick="addPlayer()" style="background: #4dabf7; color: white;">
                                â• åŠ ç©å®¶
                            </button>
                            <button class="btn-control" id="deletePlayerBtn" onclick="deletePlayer()" style="background: #fa5252; color: white;">
                                â– åˆ é™¤ç©å®¶
                            </button>
                            <button class="btn-control" onclick="resetGame()" style="background: #ff6b6b; color: white;">
                                ğŸ”„ é‡ç½®æ¸¸æˆ
                            </button>
                            <button class="btn-control btn-end" id="endBtn" onclick="endCompetition()" disabled>
                                ğŸ ç»“æŸç«èµ›
                            </button>
                        </div>
                    </div>

                    <!-- Student View Notice -->
                    <div class="student-view-notice" id="studentNotice" style="display:none;">
                        <p>ğŸ“– å­¦ç”Ÿè§†å›¾ï¼šç­‰å¾…è€å¸ˆå¼€å§‹æ¸¸æˆ</p>
                    </div>

                    <!-- Question Area -->
                    <div class="question-area">
                        <div class="timer">
                            <span id="timerDisplay">30</span> ç§’
                        </div>
                        <div class="question-display" id="questionDisplay">
                            ç­‰å¾…å¼€å§‹...
                        </div>

                        <!-- Student Answer Input -->
                        <div id="studentAnswerArea" style="display:none;">
                            <div class="student-selector">
                                <label style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; display: block;">è¾“å…¥ä½ çš„ç­”æ¡ˆï¼š</label>
                                <input type="number" id="studentAnswer" placeholder="è¾“å…¥æ•°å­—ç­”æ¡ˆ" style="width: 100%; padding: 15px; font-size: 1.5em; border: 3px solid #667eea; border-radius: 10px; text-align: center;">
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button class="answer-btn btn-correct" onclick="studentSubmitAnswer()" style="font-size: 1.5em; padding: 20px 60px;">
                                    âœ“ æäº¤ç­”æ¡ˆ
                                </button>
                            </div>
                        </div>

                        <!-- Teacher Controls -->
                        <div id="teacherControls" style="display:none;">
                            <div class="student-view-notice" style="background: #fff4e6; color: #e67700;">
                                <p>ğŸ‘¨â€ğŸ« è€å¸ˆæ§åˆ¶é¢æ¿</p>
                                <p style="margin-top:10px;">å­¦ç”Ÿä¼šåœ¨è‡ªå·±çš„è®¾å¤‡ä¸Šç­”é¢˜</p>
                            </div>
                        </div>

                        <div class="feedback" id="feedback"></div>
                    </div>
                </div>

                <!-- Leaderboard -->
                <div class="leaderboard">
                    <h2>ğŸ† å®æ—¶æ’å</h2>
                    <div id="leaderboardContent">
                        <p style="text-align:center;color:#999;">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLXwhhrpNXan4WogvOsHPIEtZQ1T2thNE",
            authDomain: "math-competition-p5.firebaseapp.com",
            databaseURL: "https://math-competition-p5-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "math-competition-p5",
            storageBucket: "math-competition-p5.firebasestorage.app",
            messagingSenderId: "432439907352",
            appId: "1:432439907352:web:a4a3d2b239973435a6df6d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game State
        let currentUser = null;
        let isTeacher = false;
        const TEACHER_PASSWORD = 'ck355091GOH!';

        // Database References
        const gameStateRef = database.ref('gameState');
        const studentsRef = database.ref('students');
        const currentQuestionRef = database.ref('currentQuestion');

        // Initialize game with default students if not exists
        function initializeGame() {
            studentsRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    const defaultStudents = {
                        'çºªå­è°¦': { score: 0, answered: 0 },
                        'å”å­è°¦': { score: 0, answered: 0 },
                        'å°¤å­ç’‡': { score: 0, answered: 0 },
                        'é™ˆæ­†åªƒ': { score: 0, answered: 0 },
                        'é™ˆå­æ¬£': { score: 0, answered: 0 },
                        'å°¤å®‰å®œ': { score: 0, answered: 0 },
                        'æ±ŸåŠ²æ¯…': { score: 0, answered: 0 },
                        'å¶éˆŠå„¿': { score: 0, answered: 0 },
                        'ç¿æ©é›…': { score: 0, answered: 0 },
                        'æ—èŠŠå¦¤': { score: 0, answered: 0 },
                        'æ—ä¿Šè±': { score: 0, answered: 0 },
                        'æ›¹ç¿': { score: 0, answered: 0 },
                        'éƒ­å¾®å¾®': { score: 0, answered: 0 }
                    };
                    studentsRef.set(defaultStudents);
                }
            });

            gameStateRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    gameStateRef.set({
                        active: false,
                        paused: false,
                        currentQuestionIndex: 0,
                        winner: null,
                        timeLeft: 30
                    });
                }
            });
            
            // Initialize current question
            currentQuestionRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    currentQuestionRef.set({
                        question: 'ç­‰å¾…å¼€å§‹...',
                        answer: 0,
                        timeLeft: 30
                    });
                }
            });
        }

        // Login System
        document.getElementById('teacherRoleBtn').onclick = function() {
            document.getElementById('teacherRoleBtn').classList.add('selected');
            document.getElementById('studentRoleBtn').classList.remove('selected');
            document.getElementById('teacherForm').classList.add('active');
            document.getElementById('studentForm').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('show');
        };

        document.getElementById('studentRoleBtn').onclick = function() {
            document.getElementById('studentRoleBtn').classList.add('selected');
            document.getElementById('teacherRoleBtn').classList.remove('selected');
            document.getElementById('studentForm').classList.add('active');
            document.getElementById('teacherForm').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('show');
        };

        function loginAsTeacher() {
            const password = document.getElementById('teacherPassword').value;
            const errorMsg = document.getElementById('errorMessage');

            if (!password) {
                errorMsg.textContent = 'è¯·è¾“å…¥å¯†ç ';
                errorMsg.classList.add('show');
                return;
            }

            if (password !== TEACHER_PASSWORD) {
                errorMsg.textContent = 'å¯†ç é”™è¯¯';
                errorMsg.classList.add('show');
                return;
            }

            currentUser = 'è€å¸ˆ';
            isTeacher = true;
            enterGame();
        }

        function loginAsStudent() {
            const studentName = document.getElementById('studentName').value;
            const errorMsg = document.getElementById('errorMessage');

            if (!studentName) {
                errorMsg.textContent = 'è¯·é€‰æ‹©ä½ çš„åå­—';
                errorMsg.classList.add('show');
                return;
            }

            currentUser = studentName;
            isTeacher = false;
            enterGame();
        }

        function enterGame() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('gameContainer').classList.add('active');
            
            document.getElementById('userName').textContent = currentUser;
            document.getElementById('userRoleBadge').textContent = isTeacher ? 'ğŸ‘¨â€ğŸ« è€å¸ˆ' : 'ğŸ‘¨â€ğŸ“ å­¦ç”Ÿ';

            if (!isTeacher) {
                // Student view - hide teacher controls, show answer input
                document.getElementById('controlPanel').style.display = 'none';
                document.getElementById('teacherControls').style.display = 'none';
                document.getElementById('studentNotice').style.display = 'block';
            } else {
                // Teacher view
                document.getElementById('studentAnswerArea').style.display = 'none';
                document.getElementById('teacherControls').style.display = 'block';
            }

            // Listen to real-time updates
            setupRealtimeListeners();
            
            // Load initial data
            loadStudents();
            loadCurrentQuestion();
            
            initializeGame();
        }

        function logout() {
            if (confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                location.reload();
            }
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            // Listen to students changes
            studentsRef.on('value', (snapshot) => {
                const students = snapshot.val() || {};
                updateLeaderboard(students);
                if (isTeacher) {
                    updateStudentDropdown(students);
                }
            });

            // Listen to current question
            let lastQuestion = null;
            currentQuestionRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('questionDisplay').textContent = data.question || 'ç­‰å¾…å¼€å§‹...';
                    document.getElementById('timerDisplay').textContent = data.timeLeft || 30;
                    
                    // Show answer input for students ONLY when game is active
                    if (!isTeacher) {
                        gameStateRef.once('value', (stateSnapshot) => {
                            const state = stateSnapshot.val() || {};
                            
                            // Only show input if game is active, not paused, and has a real question
                            const shouldShowInput = state.active && 
                                                   !state.paused && 
                                                   data.question && 
                                                   data.question !== 'ç­‰å¾…å¼€å§‹...' &&
                                                   data.question !== 'æ¸¸æˆå·²ç»“æŸ';
                            
                            if (shouldShowInput) {
                                document.getElementById('studentAnswerArea').style.display = 'block';
                                document.getElementById('studentNotice').style.display = 'none';
                                
                                // Only clear input when it's a NEW question (not just timer update)
                                if (lastQuestion !== data.question) {
                                    document.getElementById('studentAnswer').value = '';
                                    document.getElementById('studentAnswer').focus();
                                    lastQuestion = data.question;
                                }
                            } else {
                                document.getElementById('studentAnswerArea').style.display = 'none';
                                document.getElementById('studentNotice').style.display = 'block';
                                
                                // Update notice text based on state
                                const noticeElement = document.getElementById('studentNotice');
                                if (!state.active) {
                                    noticeElement.innerHTML = '<p>ğŸ“– å­¦ç”Ÿè§†å›¾ï¼šç­‰å¾…è€å¸ˆå¼€å§‹æ¸¸æˆ...</p>';
                                } else if (state.paused) {
                                    noticeElement.innerHTML = '<p>â¸ï¸ æ¸¸æˆå·²æš‚åœ</p>';
                                } else {
                                    noticeElement.innerHTML = '<p>ğŸ“– å­¦ç”Ÿè§†å›¾ï¼šç­‰å¾…è€å¸ˆå¼€å§‹æ¸¸æˆ...</p>';
                                }
                            }
                        });
                    }
                }
            });

            // Listen to game state
            gameStateRef.on('value', (snapshot) => {
                const state = snapshot.val() || {};
                
                const statusElement = document.getElementById('competitionStatus');
                if (statusElement) {
                    if (state.active) {
                        statusElement.textContent = state.paused ? 'â¸ï¸ å·²æš‚åœ' : 'ğŸ® æ¸¸æˆè¿›è¡Œä¸­';
                    } else {
                        statusElement.textContent = 'å‡†å¤‡å¼€å§‹ç«èµ›';
                    }
                }

                // Update button states for teacher
                if (isTeacher) {
                    const startBtn = document.getElementById('startAllBtn');
                    const pauseBtn = document.getElementById('pauseBtn');
                    const endBtn = document.getElementById('endBtn');
                    
                    if (startBtn) startBtn.disabled = state.active;
                    if (pauseBtn) pauseBtn.disabled = !state.active;
                    if (endBtn) endBtn.disabled = !state.active;
                }
                
                // Update student interface based on game state
                if (!isTeacher) {
                    if (!state.active || state.paused) {
                        // Hide answer input if game is not active or paused
                        document.getElementById('studentAnswerArea').style.display = 'none';
                        document.getElementById('studentNotice').style.display = 'block';
                        
                        const noticeElement = document.getElementById('studentNotice');
                        if (!state.active) {
                            noticeElement.innerHTML = '<p>ğŸ“– å­¦ç”Ÿè§†å›¾ï¼šç­‰å¾…è€å¸ˆå¼€å§‹æ¸¸æˆ...</p>';
                        } else if (state.paused) {
                            noticeElement.innerHTML = '<p>â¸ï¸ æ¸¸æˆå·²æš‚åœï¼Œç­‰å¾…ç»§ç»­...</p>';
                        }
                    } else {
                        // Game is active - show input
                        document.getElementById('studentAnswerArea').style.display = 'block';
                        document.getElementById('studentNotice').style.display = 'none';
                    }
                }

                if (state.winner) {
                    // Hide all inputs when there's a winner
                    if (!isTeacher) {
                        document.getElementById('studentAnswerArea').style.display = 'none';
                    }
                    showWinner(state.winner);
                }
            });
        }

        function loadStudents() {
            studentsRef.once('value', (snapshot) => {
                const students = snapshot.val() || {};
                updateLeaderboard(students);
                updateStudentDropdown(students);
            });
        }

        function loadCurrentQuestion() {
            currentQuestionRef.once('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('questionDisplay').textContent = data.question || 'ç­‰å¾…å¼€å§‹...';
                }
            });
        }

        function updateLeaderboard(students) {
            const sortedStudents = Object.entries(students).sort((a, b) => b[1].score - a[1].score);
            const leaderboardHTML = sortedStudents.map((student, index) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
                return `
                    <div class="student-card ${rankClass}">
                        <div class="student-info">
                            <div class="rank-badge">${index + 1}</div>
                            <div class="student-name">${medal} ${student[0]}</div>
                        </div>
                        <div class="student-score">${student[1].score}åˆ†</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboardContent').innerHTML = leaderboardHTML;
        }

        function updateStudentDropdown(students) {
            if (!isTeacher) return;
            
            const select = document.getElementById('studentSelect');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            Object.keys(students).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function showMessage(text, type) {
            if (!isTeacher) return;
            
            const msgArea = document.getElementById('messageArea');
            const msg = document.createElement('div');
            msg.className = 'message';
            
            if (type === 'success') {
                msg.style.background = '#d3f9d8';
                msg.style.color = '#2f9e44';
            } else if (type === 'error') {
                msg.style.background = '#ffe3e3';
                msg.style.color = '#c92a2a';
            } else {
                msg.style.background = '#e7f5ff';
                msg.style.color = '#1971c2';
            }
            
            msg.textContent = text;
            msgArea.appendChild(msg);
            
            setTimeout(() => {
                if (msgArea.contains(msg)) {
                    msgArea.removeChild(msg);
                }
            }, 3000);
        }

        function showWinner(winnerName) {
            alert('ğŸ‰ æ¸¸æˆç»“æŸï¼\n\nğŸ† è·èƒœè€…ï¼š' + winnerName + '\n\næ­å–œï¼ï¼ï¼');
        }

        // Student submits answer
        function studentSubmitAnswer() {
            if (isTeacher) return;
            
            // First check if game is active
            gameStateRef.once('value', (stateSnapshot) => {
                const state = stateSnapshot.val() || {};
                
                if (!state.active || state.paused) {
                    alert('æ¸¸æˆæœªå¼€å§‹æˆ–å·²æš‚åœï¼');
                    return;
                }
                
                const answerInput = document.getElementById('studentAnswer');
                const studentAnswer = parseInt(answerInput.value);
                
                if (isNaN(studentAnswer)) {
                    alert('è¯·è¾“å…¥æ•°å­—ç­”æ¡ˆ');
                    return;
                }
                
                // Get current question
                currentQuestionRef.once('value', (snapshot) => {
                    const questionData = snapshot.val();
                    if (!questionData || !questionData.question || questionData.question === 'ç­‰å¾…å¼€å§‹...') {
                        alert('æ²¡æœ‰é¢˜ç›®å¯ä»¥å›ç­”ï¼');
                        return;
                    }
                    
                    const correctAnswer = questionData.answer;
                    const isCorrect = studentAnswer === correctAnswer;
                    
                    // Update student score
                    studentsRef.child(currentUser).once('value', (studentSnapshot) => {
                        const student = studentSnapshot.val();
                        const scoreChange = isCorrect ? 3 : -5;
                        const newScore = student.score + scoreChange;
                        
                        studentsRef.child(currentUser).update({
                            score: newScore,
                            answered: student.answered + 1
                        });
                        
                        // Show feedback
                        const feedback = document.getElementById('feedback');
                        if (isCorrect) {
                            feedback.className = 'feedback correct';
                            feedback.textContent = `âœ“ ç­”å¯¹äº†ï¼+3åˆ†`;
                            showEmojiFeedback(true);
                            
                            // Clear the timer
                            if (questionTimerInterval) {
                                clearInterval(questionTimerInterval);
                                questionTimerInterval = null;
                            }
                            
                            // Auto-generate next question after 2 seconds
                            setTimeout(() => {
                                feedback.textContent = '';
                                feedback.className = 'feedback';
                                
                                // Only generate next question if no one else already did
                                currentQuestionRef.once('value', (qCheck) => {
                                    const currentQ = qCheck.val();
                                    // Check if question is still the one we answered (not already changed)
                                    if (currentQ && currentQ.answer === correctAnswer) {
                                        // We are the first one to answer correctly
                                        generateNextQuestion();
                                    }
                                });
                            }, 2000);
                            
                        } else {
                            feedback.className = 'feedback incorrect';
                            feedback.textContent = `âœ— ç­”é”™äº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ ${correctAnswer}ã€‚-5åˆ†`;
                            showEmojiFeedback(false);
                            
                            // Clear feedback after 3 seconds
                            setTimeout(() => {
                                feedback.textContent = '';
                                feedback.className = 'feedback';
                            }, 3000);
                        }
                        
                        // Clear input but keep it visible
                        answerInput.value = '';
                        
                        // Check for winner
                        if (newScore >= 80) {
                            gameStateRef.update({
                                winner: currentUser,
                                active: false
                            });
                        }
                    });
                });
            });
        }

        function showEmojiFeedback(isCorrect) {
            const emojis = {
                correct: ['ğŸ‰', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸŠ', 'ğŸ‘', 'ğŸ†', 'ğŸ’¯', 'ğŸ˜Š', 'ğŸ¥³'],
                incorrect: ['ğŸ‘»', 'ğŸ˜±', 'ğŸ˜µ', 'ğŸ™ˆ', 'ğŸ˜–', 'ğŸ˜­', 'ğŸ’€', 'ğŸ¤¦', 'ğŸ˜¢', 'ğŸ˜“']
            };
            
            const emojiList = isCorrect ? emojis.correct : emojis.incorrect;
            const randomEmoji = emojiList[Math.floor(Math.random() * emojiList.length)];
            
            const emojiElement = document.createElement('div');
            emojiElement.className = 'emoji-feedback';
            emojiElement.textContent = randomEmoji;
            document.body.appendChild(emojiElement);
            
            setTimeout(() => {
                if (document.body.contains(emojiElement)) {
                    document.body.removeChild(emojiElement);
                }
            }, 1000);
        }

        // Teacher Functions
        function startCompetition() {
            if (!isTeacher) return;
            
            gameStateRef.update({
                active: true,
                paused: false,
                currentQuestionIndex: 0,
                winner: null
            });
            
            // Generate first question (this will also start the timer)
            generateNextQuestion();
            
            showMessage('âœ… æ¸¸æˆå¼€å§‹ï¼', 'success');
        }

        let questionTimerInterval = null;

        function startQuestionTimer() {
            // Always clear any existing timer first
            if (questionTimerInterval) {
                clearInterval(questionTimerInterval);
                questionTimerInterval = null;
            }
            
            // Check if game is active before starting timer
            gameStateRef.once('value', (snapshot) => {
                const state = snapshot.val() || {};
                if (!state.active || state.paused) {
                    // Game not active, don't start timer
                    return;
                }
                
                let timeLeft = 30;
                currentQuestionRef.update({ timeLeft: timeLeft });
                
                questionTimerInterval = setInterval(() => {
                    // Double-check game is still active
                    gameStateRef.once('value', (snap) => {
                        const st = snap.val() || {};
                        if (!st.active || st.paused) {
                            clearInterval(questionTimerInterval);
                            questionTimerInterval = null;
                            return;
                        }
                        
                        timeLeft--;
                        currentQuestionRef.update({ timeLeft: timeLeft });
                        
                        if (timeLeft <= 0) {
                            clearInterval(questionTimerInterval);
                            questionTimerInterval = null;
                            handleTimeout();
                        }
                    });
                }, 1000);
            });
        }

        function handleTimeout() {
            // Check if question is still the current one (not already answered correctly)
            currentQuestionRef.once('value', (checkSnapshot) => {
                const checkData = checkSnapshot.val();
                if (!checkData || checkData.timeLeft > 0) {
                    // Question already changed or time not up, someone answered it
                    return;
                }
                
                // Deduct 8 points from all students
                studentsRef.once('value', (snapshot) => {
                    const students = snapshot.val() || {};
                    Object.keys(students).forEach(name => {
                        const newScore = students[name].score - 8;
                        studentsRef.child(name).update({
                            score: newScore
                        });
                    });
                });
                
                // Show timeout message
                const feedback = document.getElementById('feedback');
                feedback.className = 'feedback incorrect';
                feedback.textContent = `â° æ—¶é—´åˆ°ï¼æ²¡äººç­”å¯¹ï¼å…¨ä½“-8åˆ†ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯ ${checkData.answer}ã€‚`;
                
                setTimeout(() => {
                    feedback.textContent = '';
                    feedback.className = 'feedback';
                    // generateNextQuestion already starts the timer
                    generateNextQuestion();
                }, 3000);
            });
        }

        function pauseCompetition() {
            if (!isTeacher) return;
            
            gameStateRef.once('value', (snapshot) => {
                const state = snapshot.val() || {};
                const newPausedState = !state.paused;
                
                gameStateRef.update({
                    paused: newPausedState
                });
                
                if (newPausedState) {
                    // Pause timer
                    if (questionTimerInterval) {
                        clearInterval(questionTimerInterval);
                    }
                } else {
                    // Resume timer
                    currentQuestionRef.once('value', (qSnapshot) => {
                        const data = qSnapshot.val();
                        if (data && data.timeLeft > 0) {
                            startQuestionTimer();
                        }
                    });
                }
                
                showMessage(newPausedState ? 'â¸ï¸ æ¸¸æˆæš‚åœ' : 'â–¶ï¸ æ¸¸æˆç»§ç»­', 'info');
            });
        }

        function endCompetition() {
            if (!isTeacher) return;
            
            if (confirm('ç¡®å®šè¦ç»“æŸç«èµ›å—ï¼Ÿ')) {
                if (questionTimerInterval) {
                    clearInterval(questionTimerInterval);
                    questionTimerInterval = null;
                }
                
                gameStateRef.update({
                    active: false,
                    paused: false
                });
                
                currentQuestionRef.update({
                    question: 'æ¸¸æˆå·²ç»“æŸ',
                    timeLeft: 0
                });
                
                showMessage('ğŸ æ¸¸æˆå·²ç»“æŸ', 'info');
            }
        }

        function generateNextQuestion() {
            // Check if game is still active
            gameStateRef.once('value', (snapshot) => {
                const state = snapshot.val() || {};
                if (!state.active || state.paused) return;
                
                // Clear any existing timer first - CRITICAL
                if (questionTimerInterval) {
                    clearInterval(questionTimerInterval);
                    questionTimerInterval = null;
                }
                
                // Simple math question generator
                const operations = ['+', '-', 'Ã—', 'Ã·'];
                const op = operations[Math.floor(Math.random() * operations.length)];
                let num1 = Math.floor(Math.random() * 100) + 1;
                let num2 = Math.floor(Math.random() * 50) + 1;
                
                let question, answer;
                
                switch(op) {
                    case '+':
                        answer = num1 + num2;
                        question = `${num1} + ${num2} = ?`;
                        break;
                    case '-':
                        if (num1 < num2) [num1, num2] = [num2, num1];
                        answer = num1 - num2;
                        question = `${num1} - ${num2} = ?`;
                        break;
                    case 'Ã—':
                        num1 = Math.floor(Math.random() * 20) + 1;
                        num2 = Math.floor(Math.random() * 20) + 1;
                        answer = num1 * num2;
                        question = `${num1} Ã— ${num2} = ?`;
                        break;
                    case 'Ã·':
                        num2 = Math.floor(Math.random() * 12) + 1;
                        answer = Math.floor(Math.random() * 15) + 1;
                        num1 = num2 * answer;
                        question = `${num1} Ã· ${num2} = ?`;
                        break;
                }
                
                currentQuestionRef.set({
                    question: question,
                    answer: answer,
                    timeLeft: 30
                }).then(() => {
                    // Start timer ONLY after question is saved
                    // Wait a bit to ensure all clients see the question change
                    setTimeout(() => {
                        startQuestionTimer();
                    }, 100);
                });
            });
        }

        function addPlayer() {
            if (!isTeacher) return;
            // This would show a modal - simplified for now
            const name = prompt('è¾“å…¥æ–°ç©å®¶åå­—ï¼š');
            if (name && name.trim()) {
                studentsRef.child(name).set({
                    score: 0,
                    answered: 0
                });
                showMessage(`âœ… æ·»åŠ ç©å®¶ï¼š${name}`, 'success');
            }
        }

        function deletePlayer() {
            if (!isTeacher) return;
            // This would show a modal - simplified for now
            studentsRef.once('value', (snapshot) => {
                const students = snapshot.val();
                const names = Object.keys(students);
                const name = prompt('é€‰æ‹©è¦åˆ é™¤çš„ç©å®¶ï¼š\n\n' + names.join('\n'));
                
                if (name && students[name]) {
                    if (confirm(`ç¡®å®šåˆ é™¤ ${name}?`)) {
                        studentsRef.child(name).remove();
                        showMessage(`âœ… åˆ é™¤ç©å®¶ï¼š${name}`, 'success');
                    }
                }
            });
        }

        function resetGame() {
            if (!isTeacher) return;
            
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰åˆ†æ•°å—ï¼Ÿ')) {
                // Stop timer
                if (questionTimerInterval) {
                    clearInterval(questionTimerInterval);
                    questionTimerInterval = null;
                }
                
                studentsRef.once('value', (snapshot) => {
                    const students = snapshot.val();
                    Object.keys(students).forEach(name => {
                        studentsRef.child(name).update({
                            score: 0,
                            answered: 0
                        });
                    });
                });
                
                gameStateRef.update({
                    active: false,
                    paused: false,
                    currentQuestionIndex: 0,
                    winner: null
                });
                
                currentQuestionRef.set({
                    question: 'ç­‰å¾…å¼€å§‹...',
                    answer: 0,
                    timeLeft: 30
                });
                
                showMessage('ğŸ”„ æ¸¸æˆå·²é‡ç½®', 'success');
            }
        }
    </script>
</body>
</html>
